---

# yamllint disable rule:line-length

name: publish docker container

on: push

env:
  MANTA_BINARY_REF: v3.0.4-calamari.kusama # todo: swap for release name after trigger change
  MANTA_GENESIS_REF: ${{ github.sha }} # todo: swap for release name after trigger change
  POLKA_GENESIS_REF: v0.9.9-1 # todo: keep in sync with upstream deps
  CONTAINER_REF: ${{ github.sha }} # todo: swap for release name after trigger change

jobs:
  docker-hub-deploy:
    runs-on: ubuntu-latest
    steps:
      -
        uses: docker/setup-buildx-action@v1
      -
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.MANTABOT_DOCKER_USERNAME }}
          password: ${{ secrets.MANTABOT_DOCKER_TOKEN }}
      -
        id: docker-build
        uses: docker/build-push-action@v2
        with:
          push: true
          file: docker/calamari.Dockerfile
          tags: |
            mantabot/calamari:latest
            mantabot/calamari:${{ env.CONTAINER_REF }}
          build-args: |
            PARA_BINARY_URL=https://github.com/Manta-Network/Manta/releases/download/${{ env.MANTA_BINARY_REF }}/calamari-pc
            PARA_GENESIS_URL=https://raw.githubusercontent.com/Manta-Network/Manta/${{ env.MANTA_GENESIS_REF }}/genesis/calamari-genesis.json
            RELAY_GENESIS_URL=https://raw.githubusercontent.com/paritytech/polkadot/${{ env.POLKA_GENESIS_REF }}/node/service/res/kusama.json
      -
        run: echo ${{ steps.docker-build.outputs.digest }}

# yamllint enable rule:line-length